<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Movimentação de Patrimônio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <style>
        video#camera-preview {
            max-width: 100%; 
            height: auto; 
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="text-center">Movimentação de Patrimônio - Iniciar</h2>
                <form action="processar_movimento.php" method="post" id="formMovimentacao">
                    <div class="form-group">
                        <label for="id_patrimonio">Patrimônio:</label>
                        <input type="text" class="form-control" id="id_patrimonio" name="id_patrimonio" placeholder="Identificação do patrimônio" required>
                    </div>
                    <button id="start-scan-btn" class="btn btn-primary">Ler QR Code</button>
                    <button id="stop-scan-btn" class="btn btn-danger" style="display:none;">Fechar Câmera</button>
                    <div class="mt-3">
                        <video id="camera-preview" playsinline style="display: none;"></video>
                    </div>
                    <canvas id="qr-canvas" style="display: none;"></canvas>
                    <div class="form-group">
                        <label for="cd_local_atual">Local Atual:</label>
                        <select class="form-control" id="cd_local_atual" name="cd_local_atual" required>
                            <!-- Aqui o local atual será preenchido automaticamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cd_local">Local de Destino:</label>
                        <select class="form-control" id="cd_local" name="cd_local" required>
                            <option value=""></option>
                            <?php
                            $sql="SELECT cd_local,desc_local FROM local;";
                            $resultado = mysqli_query($con, $sql);
                            while($row = mysqli_fetch_assoc($resultado)) {
                                echo '<option value="'.$row['cd_local'].'">'.$row['cd_local']. ' - '.$row['desc_local'].'</option>';
                            } 
                            ?>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Gravar</button>
                </form>
            </div>
            
        </div>
    </div>

    <script>
        $(document).ready(function(){
            let stream = null;
            const cameraPreview = document.getElementById('camera-preview');
            const qrCanvas = document.getElementById('qr-canvas');
            const startScanBtn = document.getElementById('start-scan-btn');
            const stopScanBtn = document.getElementById('stop-scan-btn');
            let intervalId = null;

            startScanBtn.addEventListener('click', function() {
                const constraints = { video: { facingMode: "environment" } };

                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(s) {
                        stream = s;
                        cameraPreview.srcObject = stream;
                        cameraPreview.onloadedmetadata = function(e) {
                            cameraPreview.play();
                            cameraPreview.style.display = 'block';
                            startScanBtn.style.display = 'none';
                            stopScanBtn.style.display = 'block';
                            intervalId = setInterval(checkForQRCode, 1000);
                        };
                    })
                    .catch(function(error) {
                        console.error('Erro ao acessar câmera:', error);
                        alert('Erro ao acessar câmera: ' + error);
                    });
            });

            stopScanBtn.addEventListener('click', function() {
                stopCamera();
            });

            function stopCamera() {
                if (stream) {
                    const tracks = stream.getTracks();
                    tracks.forEach(function(track) {
                        track.stop();
                    });
                    cameraPreview.style.display = 'none';
                    stopScanBtn.style.display = 'none';
                    startScanBtn.style.display = 'block';
                    clearInterval(intervalId);
                }
            }

            function checkForQRCode() {
                const ctx = qrCanvas.getContext('2d');
                qrCanvas.width = cameraPreview.videoWidth;
                qrCanvas.height = cameraPreview.videoHeight;
                ctx.drawImage(cameraPreview, 0, 0, qrCanvas.width, qrCanvas.height);

                const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    stopCamera(); // Fecha a câmera quando um QR code é detectado
                    const firstPartOnly = code.data.split(' ')[0];
                    const secondPart = code.data.split(' ')[2];
                    document.getElementById('id_patrimonio').value = firstPartOnly;
                    document.getElementById('label-result').innerText = 'Descrição: ' + secondPart;

                    // Executar AJAX para buscar o local atual do patrimônio
                    $.ajax({
                        url: 'buscar_local_atual.php',
                        type: 'POST',
                        data: {id_patrimonio: firstPartOnly},
                        success: function(response){
                            $('#cd_local_atual').html(response);
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
